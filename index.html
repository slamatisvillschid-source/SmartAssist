<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Smart Assistive Door & Energy System</title>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.5.0/p5.min.js"></script>
  <script src="https://unpkg.com/ml5@latest/dist/ml5.min.js"></script>
  <script src="https://unpkg.com/p5.webserial/dist/p5.webserial.js"></script>

  <style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f4f4f9; color: #333; text-align: center; }
    h1 { color: #2c3e50; }
    
    .container {
      display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; padding: 20px;
    }
    
    .video-box {
      border: 5px solid #ccc; border-radius: 10px; overflow: hidden;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1); width: 320px; height: 240px; background: #000;
    }

    .panel {
      background: white; padding: 20px; border-radius: 10px; width: 300px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1); text-align: left;
    }

    .status-active { color: green; font-weight: bold; }
    .status-inactive { color: red; font-weight: bold; }
    .status-warning { color: orange; font-weight: bold; }
    
    button {
      width: 100%; padding: 10px; margin-top: 10px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px;
    }
    .btn-connect { background-color: #3498db; color: white; }
    .btn-connect:disabled { background-color: #bdc3c7; cursor: not-allowed; }
    .btn-stop { background-color: #e74c3c; color: white; }

    #alarm-msg { display: none; background: #e74c3c; color: white; padding: 10px; margin-top: 10px; border-radius: 5px; }
  </style>
</head>

<body>

  <h1>Smart Assistive Door & Energy System</h1>

  <audio id="alarmSound" src="https://actions.google.com/sounds/v1/alarms/mechanic_clock_ring.ogg"></audio>

  <div id="alarm-msg">‚ö†Ô∏è PERINGATAN: PENYUSUP TERDETEKSI! ‚ö†Ô∏è</div>

  <div class="container">
    <div id="canvas-container" class="video-box"></div>

    <div class="panel">
      <h3>Sistem Kontrol</h3>
      <p>Deteksi: <b id="label-display" style="font-size: 1.2em;">Memuat Model...</b></p>
      <p>Akses: <span id="access-status">üîí Terkunci</span></p>
      
      <button id="btn-connect" class="btn-connect" onclick="connectSerial()" disabled>
        üîå Hubungkan Arduino
      </button>
      <p style="font-size: 12px; color: gray;">*Tombol aktif hanya jika Pemilik terlihat</p>
    </div>

    <div class="panel">
      <h3>Status Perangkat</h3>
      <p>üö™ Pintu: <span id="door-status" class="status-inactive">TERTUTUP</span></p>
      <p>üí° Lampu (4 Unit): <span id="light-status" class="status-inactive">MATI</span></p>
      <hr>
      <p>‚è±Ô∏è Durasi Nyala: <b id="duration-txt">0 detik</b></p>
      <p>‚ö° Estimasi Biaya: Rp <b id="cost-txt">0</b></p>
      
      <button class="btn-stop" onclick="stopSystem()">üõë Stop & Kirim Laporan</button>
    </div>
  </div>

<script>
  // --- KONFIGURASI TELEGRAM ---
  const BOT_TOKEN = "8227143038:AAH6f9KMkD7GU3ZVAfl3E0y2zYG51LyUYTo";
  const CHAT_ID = "275146230";

  // --- LINK MODEL TEACHABLE MACHINE ---
  // Ganti link di bawah ini dengan link model Anda sendiri!
  let imageModelURL = 'https://teachablemachine.withgoogle.com/models/1TcxLgfyoh/';

  // --- VARIABEL SISTEM ---
  let classifier, video, flippedVideo;
  let label = "";
  let serial; // Objek Serial
  
  // Status Logic
  let isOwnerIdentified = false;
  let isArduinoConnected = false;
  let isSystemRunning = true;

  // Status Perangkat
  let isLightOn = false;
  let isDoorOpen = false;
  
  // Timer & Security
  let doorTimer = 0;
  let intruderCooldown = 0; // Agar telegram tidak spam
  let emptyRoomTimer = 0;   // Timer untuk mematikan lampu otomatis

  // Kalkulasi Energi
  let lightStartTime = 0;
  let accumulatedTime = 0; // detik total sesi sebelumnya
  const WATT_PER_LAMPU = 10; //
