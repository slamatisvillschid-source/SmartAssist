<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>SMART ASSIST</title>
    <style>
        :root { --primary: #3b82f6; --danger: #ef4444; --success: #22c55e; --bg: #0f172a; --panel: #1e293b; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: white; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        .sidebar { width: 380px; background: var(--panel); padding: 25px; border-right: 1px solid #334155; display: flex; flex-direction: column; gap: 15px; }
        .control-card { background: #0f172a; padding: 15px; border-radius: 12px; border: 1px solid #334155; }
        
        /* Stats Panel */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .stat-box { background: #1e293b; padding: 10px; border-radius: 8px; text-align: center; border: 1px solid #334155; }
        .stat-val { display: block; font-size: 1.1rem; font-weight: bold; color: #60a5fa; }
        .stat-label { font-size: 0.7rem; color: #94a3b8; text-transform: uppercase; }

        button { padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: 0.3s; width: 100%; }
        .btn-camera { background: var(--primary); color: white; margin-bottom: 5px; }
        .btn-report { background: #9333ea; color: white; margin-top: 10px; }
        .btn-report:hover { background: #a855f7; }
        .btn-connect { background: #475569; color: #94a3b8; cursor: not-allowed; }
        .btn-connect.active { background: var(--success); color: white; cursor: pointer; }

        #canvas-wrapper { position: relative; border-radius: 20px; border: 6px solid #334155; background: #000; overflow: hidden; line-height: 0; }
        #status-label { margin-top: 20px; font-size: 1.8rem; font-weight: 800; color: #60a5fa; }
        #log { height: 120px; background: #000; border-radius: 8px; padding: 10px; font-family: monospace; font-size: 11px; color: #10b981; overflow-y: auto; border: 1px solid #334155; }
        
        .main-content { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    </style>
</head>
<body>

<div class="sidebar">
    <h2 style="margin:0; font-size: 1.2rem; color: #60a5fa;">âš¡ ENERGY MONITOR AI</h2>
    
    <button class="btn-camera" id="start-btn" onclick="init()">Aktifkan Kamera</button>
    <button id="conn-btn" class="btn-connect" onclick="connectSerial()" disabled>Hubungkan Arduino</button>

    <div class="control-card">
        <div class="stat-label" style="margin-bottom: 8px;">Konsumsi Listrik (4 Lampu - 40W)</div>
        <div class="stats-grid">
            <div class="stat-box"><span class="stat-val" id="timer-val">0s</span><span class="stat-label">Durasi</span></div>
            <div class="stat-box"><span class="stat-val" id="cost-val">Rp 0</span><span class="stat-label">Estimasi Biaya</span></div>
        </div>
        <button class="btn-report" onclick="sendTelegramReport()">ðŸ“¤ Kirim Laporan ke Telegram</button>
    </div>

    <div id="log">Menunggu aktivasi...</div>
</div>

<div class="main-content">
    <div id="canvas-wrapper"><canvas id="canvas"></canvas></div>
    <div id="status-label">OFFLINE</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.3.1/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@teachablemachine/pose@0.8/dist/teachablemachine-pose.min.js"></script>

<script>
    const URL = "https://teachablemachine.withgoogle.com/models/ZMNrCQrv8/"; 
    const TG_TOKEN = "8227143038:AAH6f9KMkD7GU3ZVAfl3E0y2zYG51LyUYTo";
    const TG_CHAT_ID = "275146230 ";

    let model, webcam, ctx, writer;
    let isOwnerVerified = false;
    let lastLogMessage = "";
    
    // Energy Variables
    let lightStartTime = null;
    let totalSecondsActive = 0;
    const TOTAL_WATT = 40; // 4 lampu x 10W
    const TARIFF_KWH = 1444; // Harga per kWh

    async function init() {
        model = await tmPose.load(URL + "model.json", URL + "metadata.json");
        webcam = new tmPose.Webcam(600, 450, true);
        await webcam.setup();
        await webcam.play();
        window.requestAnimationFrame(loop);
        const canvas = document.getElementById("canvas");
        canvas.width = 600; canvas.height = 450;
        ctx = canvas.getContext("2d");
        addLog("Sistem Aktif.");
    }

    async function loop() {
        webcam.update();
        if (lightStartTime) updateEnergyCounter();
        await predict();
        window.requestAnimationFrame(loop);
    }

    async function predict() {
        const { pose, posenetOutput } = await model.estimatePose(webcam.canvas);
        const prediction = await model.predict(posenetOutput);
        drawPose(pose);
        let highest = { name: "", prob: 0 };
        prediction.forEach(p => { if(p.probability > highest.prob) highest = { name: p.className, prob: p.probability }; });

        if(highest.prob > 0.85) {
            document.getElementById("status-label").innerText = highest.name;
            handleLogic(highest.name);
        }
    }

    function handleLogic(name) {
        if(name === "Pemilik" && !isOwnerVerified) {
            isOwnerVerified = true;
            document.getElementById("conn-btn").disabled = false;
            document.getElementById("conn-btn").classList.add("active");
            addLog("Akses Dibuka.");
        }
        if(!isOwnerVerified) return;

        // Lampu Logic
        if(name === "Menyalakan Lampu" && !lightStartTime) {
            lightStartTime = Date.now();
            sendSerial("LED_ON");
            addLog("Lampu ON - Perhitungan energi dimulai.");
        } 
        else if(name === "Kosong" && lightStartTime) {
            let sessionTime = (Date.now() - lightStartTime) / 1000;
            totalSecondsActive += sessionTime;
            lightStartTime = null;
            sendSerial("LED_OFF");
            addLog(`Lampu OFF. Sesi: ${sessionTime.toFixed(1)}s`);
        }
    }

    function updateEnergyCounter() {
        let currentSession = (Date.now() - lightStartTime) / 1000;
        let total = totalSecondsActive + currentSession;
        document.getElementById("timer-val").innerText = Math.floor(total) + "s";
        
        // kWh = (Watt * hours) / 1000
        let kwh = (TOTAL_WATT * (total / 3600)) / 1000;
        let cost = kwh * TARIFF_KWH;
        document.getElementById("cost-val").innerText = "Rp " + cost.toFixed(2);
    }

    async function sendTelegramReport() {
        const total = document.getElementById("timer-val").innerText;
        const cost = document.getElementById("cost-val").innerText;
        const message = `ðŸ“Š *LAPORAN EFISIENSI ENERGI AI*%0A---------------------------%0AðŸ’¡ Status: 4 Lampu (40W)%0Aâ± Durasi Total: ${total}%0AðŸ’° Est. Biaya: ${cost}%0Aâœ… Status Sistem: Aman`;
        
        try {
            await fetch(`https://api.telegram.org/bot${TG_TOKEN}/sendMessage?chat_id=${TG_CHAT_ID}&text=${message}&parse_mode=Markdown`);
            addLog("Laporan berhasil dikirim ke Telegram!");
        } catch (e) { addLog("Gagal kirim laporan."); }
    }

    // --- Helper Functions (Draw, Serial, Log) ---
    function drawPose(pose) { ctx.drawImage(webcam.canvas, 0, 0); if (pose) tmPose.drawSkeleton(pose.keypoints, 0.5, ctx); }
    async function connectSerial() { try { const port = await navigator.serial.requestPort(); await port.open({ baudRate: 9600 }); writer = port.writable.getWriter(); addLog("Arduino Connect!"); } catch(e) {} }
    async function sendSerial(m) { if(writer) writer.write(new TextEncoder().encode(m + "\n")); }
    function addLog(m) { if(m !== lastLogMessage) { const b = document.getElementById("log"); b.innerHTML = `> ${m}<br>` + b.innerHTML; lastLogMessage = m; } }
</script>
</body>
</html>
