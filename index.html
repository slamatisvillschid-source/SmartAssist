<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Smart Assistive Door - Camera Fix</title>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
  <script src="https://unpkg.com/ml5@latest/dist/ml5.min.js"></script>
  <script src="https://unpkg.com/p5.webserial/dist/p5.webserial.js"></script>

  <style>
    body { font-family: sans-serif; background: #f0f2f5; text-align: center; color: #333; }
    h1 { margin-bottom: 5px; color: #2c3e50; }
    
    .container { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; padding: 20px; }
    
    .video-wrapper {
      position: relative;
      width: 320px; height: 240px;
      background: #000;
      border-radius: 10px; overflow: hidden;
      border: 4px solid #333;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      display: flex; align-items: center; justify-content: center;
    }
    
    /* Agar canvas p5.js pas di tengah */
    #canvas-container canvas { display: block; }
    
    .panel {
      background: white; padding: 20px; border-radius: 10px; width: 300px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1); text-align: left;
    }

    button { width: 100%; padding: 12px; margin-top: 10px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 14px; }
    .btn-cam { background: #8e44ad; color: white; }
    .btn-connect { background: #2980b9; color: white; }
    .btn-connect:disabled { background: #bdc3c7; cursor: not-allowed; }
    .btn-stop { background: #c0392b; color: white; }

    .status-text { font-size: 18px; font-weight: bold; color: #2c3e50; }
    .active { color: #27ae60; }
    .inactive { color: #c0392b; }
    
    #alarm-banner {
      display: none; background: #e74c3c; color: white; padding: 10px; 
      margin: 10px auto; width: 80%; border-radius: 5px; animation: pulse 1s infinite;
    }
    @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
  </style>
</head>

<body>

  <h1>Smart Assistive System</h1>
  <div id="alarm-banner">‚ö†Ô∏è PERINGATAN: PENYUSUP TERDETEKSI! ‚ö†Ô∏è</div>
  <audio id="alarmSound" src="https://actions.google.com/sounds/v1/alarms/mechanic_clock_ring.ogg"></audio>

  <div class="container">
    
    <div style="display: flex; flex-direction: column; align-items: center;">
      <button id="btn-cam" class="btn-cam" onclick="startCamera()">üì∑ AKTIFKAN KAMERA</button>
      <br>
      <div id="canvas-container" class="video-wrapper">
        <p id="loading-text" style="color:white; position:absolute;">Menunggu Tombol...</p>
      </div>
      <p>Status AI: <span id="ai-status">Off</span></p>
    </div>

    <div class="panel">
      <h3>Kontrol Akses</h3>
      <p>Deteksi: <b id="label-result" style="color:blue; font-size:1.4em;">-</b></p>
      <button id="btn-connect" class="btn-connect" onclick="connectSerial()" disabled>üîå Hubungkan Arduino</button>
      <p style="font-size: 0.8em; color: gray;">*Tombol aktif jika 'Pemilik' terdeteksi.</p>
    </div>

    <div class="panel">
      <h3>Monitoring Energi</h3>
      <p>Pintu: <b id="door-st" class="inactive">TERTUTUP</b></p>
      <p>Lampu: <b id="light-st" class="inactive">MATI</b></p>
      <hr>
      <p>Durasi: <span id="time-st">0</span> detik</p>
      <p>Biaya: Rp <span id="cost-st">0</span></p>
      <button class="btn-stop" onclick="stopSystem()">üõë Stop & Kirim Laporan</button>
    </div>
  </div>

<script>
  // --- KONFIGURASI ---
  const BOT_TOKEN = "8227143038:AAH6f9KMkD7GU3ZVAfl3E0y2zYG51LyUYTo";
  const CHAT_ID = "275146230";
  
  // !!! GANTI DENGAN LINK MODEL ANDA !!!
  let imageModelURL = 'https://teachablemachine.withgoogle.com/models/1TcxLgfyoh/';

  // --- VARIABEL ---
  let classifier, video;
  let label = "Menunggu...";
  let serial;
  
  // Flag
  let cameraActive = false;
  let arduinoReady = false;
  let systemRunning = true;

  // Logic Variables
  let isLightOn = false;
  let isDoorOpen = false;
  let doorTimer = 0;
  let emptyTimer = 0;
  let intruderTimer = 0;
  
  // Energy
  let lightStart = 0;
  let totalSeconds = 0;
  const WATT = 40; // 4 lampu x 10 watt
  const TARIF = 1444;

  function preload() {
    classifier = ml5.imageClassifier(imageModelURL + 'model.json', () => {
      console.log("Model Loaded!");
      document.getElementById('ai-status').innerText = "Model Siap via Cloud";
    });
  }

  function setup() {
    // Membuat canvas seukuran video standar
    let cnv = createCanvas(320, 240);
    cnv.parent('canvas-container');
    background(20); // Layar gelap
    
    // Setup Serial
    serial = new p5.WebSerial();
    serial.on('portopen', () => {
      arduinoReady = true;
      alert("Arduino Terhubung!");
      document.getElementById('btn-connect').innerText = "‚úÖ Arduino Terhubung";
      document.getElementById('btn-connect').style.background = "#27ae60";
    });
  }

  function startCamera() {
    // Cek Keamanan Browser
    if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
      alert("‚ö†Ô∏è ERROR KAMERA: Browser memblokir kamera karena tidak menggunakan HTTPS. Silakan gunakan Localhost atau upload ke server HTTPS.");
    }

    document.getElementById('loading-text').innerText = "Memuat Video...";
    
    // Inisialisasi Video
    video = createCapture(VIDEO, () => {
      console.log("Kamera Berhasil Diakses");
      document.getElementById('loading-text').style.display = 'none';
      cameraActive = true;
      classifyVideo();
    });
    
    video.size(320, 240);
    video.hide(); // Sembunyikan elemen HTML video asli, kita gambar di canvas
    
    document.getElementById('btn-cam').style.display = 'none';
    document.getElementById('ai-status').innerText = "Mendeteksi...";
  }

  function draw() {
    background(0);
    
    if (cameraActive && video.loadedmetadata) {
      // TEKNIK MIRRORING MANUAL (Lebih Stabil)
      push();
      translate(width, 0);
      scale(-1, 1);
      image(video, 0, 0, width, height);
      pop();
      
      if(systemRunning) logicBrain();
    } else {
      fill(255); textAlign(CENTER);
      text("Kamera Belum Aktif", width/2, height/2);
    }
    
    // Tampilkan label hasil deteksi
    document.getElementById('label-result').innerText = label;
  }

  function logicBrain() {
    // 1. KEAMANAN
    if (label === "Orang Lain") {
      document.getElementById('alarm-banner').style.display = 'block';
      document.getElementById('alarmSound').play();
      if (millis() - intruderTimer > 15000) {
        sendTelegram("‚ö†Ô∏è PERINGATAN: Penyusup terdeteksi di kamera!");
        intruderTimer = millis();
      }
    } else {
      document.getElementById('alarm-banner').style.display = 'none';
      document.getElementById('alarmSound').pause();
    }

    // 2. OTENTIKASI PEMILIK (Buka Kunci Tombol Arduino)
    if (label === "Pemilik" && !arduinoReady) {
      document.getElementById('btn-connect').disabled = false;
    }

    // 3. LOGIKA KONTROL (Hanya jika Arduino Connect)
    if (arduinoReady) {
      
      // Buka Pintu
      if (label === "Membuka Pintu" && !isDoorOpen) {
        serial.write('O'); 
        isDoorOpen = true;
        doorTimer = millis();
        updateUI();
      }
      
      // Tutup Pintu Otomatis (5 detik)
      if (isDoorOpen && millis() - doorTimer > 5000) {
        serial.write('C'); 
        isDoorOpen = false;
        updateUI();
      }

      // Nyalakan Lampu
      if (label === "Menyalakan Lampu" && !isLightOn) {
        serial.write('L');
        isLightOn = true;
        lightStart = millis();
        updateUI();
      }

      // Matikan Lampu (Kosong)
      if (label === "Kosong") {
        emptyTimer++;
        if (emptyTimer > 100 && isLightOn) { // Delay buffer
          serial.write('D');
          addDuration();
          isLightOn = false;
          emptyTimer = 0;
          updateUI();
        }
      } else {
        emptyTimer = 0;
      }

      // Update Kalkulasi Realtime
      if (isLightOn) {
        let current = (millis() - lightStart) / 1000;
        calculateCost(totalSeconds + current);
      }
    }
  }

  // --- FUNGSI KLASIFIKASI ---
  function classifyVideo() {
    // Teachable Machine biasanya dilatih dengan gambar flip/mirror
    // Kita flip dulu sebelum dikirim ke AI
    // NOTE: ml5.flipImage kadang berat, kita kirim raw video saja jika model dilatih tanpa mirror,
    // tapi biasanya TM menghandle ini. Kita coba kirim video langsung.
    classifier.classify(video, gotResult);
  }

  function gotResult(error, results) {
    if (error) { console.error(error); return; }
    label = results[0].label;
    classifyVideo();
  }

  // --- HELPER FUNCTIONS ---
  function connectSerial() {
    if (!navigator.serial) return alert("Gunakan browser Chrome/Edge!");
    serial.requestPort();
  }

  function addDuration() {
    totalSeconds += (millis() - lightStart) / 1000;
  }

  function calculateCost(sec) {
    let hours = sec / 3600;
    let kwh = (WATT * hours) / 1000;
    let cost = Math.ceil(kwh * TARIF);
    
    document.getElementById('time-st').innerText = sec.toFixed(1);
    document.getElementById('cost-st').innerText = cost;
  }

  function updateUI() {
    let d = document.getElementById('door-st');
    let l = document.getElementById('light-st');
    
    d.innerText = isDoorOpen ? "TERBUKA" : "TERTUTUP";
    d.className = isDoorOpen ? "active" : "inactive";
    
    l.innerText = isLightOn ? "MENYALA" : "MATI";
    l.className = isLightOn ? "active" : "inactive";
  }

  function stopSystem() {
    systemRunning = false;
    if(isLightOn) addDuration();
    if(arduinoReady) { serial.write('C'); serial.write('D'); }
    
    let t = document.getElementById('time-st').innerText;
    let c = document.getElementById('cost-st').innerText;
    sendTelegram(`üõë LAPORAN TUTUP.%0ADurasi: ${t} detik%0ABiaya: Rp ${c}`);
    alert("Sistem Berhenti.");
  }

  function sendTelegram(txt) {
    fetch(`https://api.telegram.org/bot${8227143038:AAH6f9KMkD7GU3ZVAfl3E0y2zYG51LyUYTo}/sendMessage?chat_id=${275146230 }&text=${txt}`);
  }
</script>

</body>
</html>
