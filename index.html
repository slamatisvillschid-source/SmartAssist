<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>SMART ASSIST</title>
    <style>
        :root { --primary: #3b82f6; --danger: #ef4444; --success: #22c55e; --bg: #0f172a; --panel: #1e293b; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: white; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        /* Sidebar */
        .sidebar { width: 380px; background: var(--panel); padding: 25px; border-right: 1px solid #334155; display: flex; flex-direction: column; gap: 20px; }
        .btn-group { display: flex; gap: 10px; }
        
        button { flex: 1; padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: 0.3s; }
        .btn-camera { background: var(--primary); color: white; }
        .btn-connect { background: #475569; color: #94a3b8; cursor: not-allowed; }
        .btn-connect.active { background: var(--success); color: white; cursor: pointer; }

        .control-card { background: #0f172a; padding: 20px; border-radius: 12px; border: 1px solid #334155; }
        .toggle-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        
        /* Main Display */
        .main-content { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; }
        #canvas-wrapper { position: relative; border-radius: 20px; border: 6px solid #334155; background: #000; overflow: hidden; min-width: 640px; min-height: 480px; }
        #status-label { margin-top: 20px; font-size: 2rem; font-weight: 800; color: #60a5fa; }
        
        #log { height: 150px; background: #000; border-radius: 8px; padding: 10px; font-family: monospace; font-size: 12px; color: #10b981; overflow-y: auto; border: 1px solid #334155; }

        /* Loader */
        #loader { position: absolute; color: white; font-weight: bold; display: none; }

        .switch { position: relative; width: 40px; height: 22px; pointer-events: none; opacity: 0.6; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: #475569; transition: .4s; border-radius: 22px; }
        input:checked + .slider { background: var(--success); }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider:before { transform: translateX(18px); }
    </style>
</head>
<body>

<div class="sidebar">
    <h2 style="margin:0; color: #60a5fa;">üõ°Ô∏è COMMAND CENTER</h2>
    
    <div class="btn-group">
        <button class="btn-camera" id="start-btn" onclick="init()">Aktifkan Kamera</button>
        <button id="conn-btn" class="btn-connect" onclick="connectSerial()" disabled>Hubungkan Arduino</button>
    </div>

    <div class="control-card">
        <div class="toggle-item">
            <span>üîì Status Pintu</span>
            <label class="switch"><input type="checkbox" id="pintu-status"><span class="slider"></span></label>
        </div>
        <div class="toggle-item">
            <span>üí° Status Lampu</span>
            <label class="switch"><input type="checkbox" id="lampu-status"><span class="slider"></span></label>
        </div>
    </div>

    <div id="log">Sistem Siap. Klik 'Aktifkan Kamera'...</div>
</div>

<div class="main-content">
    <div id="canvas-wrapper">
        <div id="loader">MENGINISIALISASI KAMERA...</div>
        <canvas id="canvas"></canvas>
    </div>
    <div id="status-label">OFFLINE</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.3.1/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@teachablemachine/pose@0.8/dist/teachablemachine-pose.min.js"></script>

<script>
    // MASUKKAN URL MODEL ANDA DI SINI
    const URL = "https://teachablemachine.withgoogle.com/models/ZMNrCQrv8/"; 
    
    let model, webcam, ctx, writer, port;
    let isOwnerVerified = false;
    let lastLog = "";
    let servoActive = false;
    let lightActive = false;

    async function init() {
        const startBtn = document.getElementById("start-btn");
        const loader = document.getElementById("loader");
        
        try {
            startBtn.disabled = true;
            startBtn.innerText = "Memproses...";
            loader.style.display = "block";
            addLog("Meminta akses kamera...");

            // Inisialisasi Model
            const modelURL = URL + "model.json";
            const metadataURL = URL + "metadata.json";
            model = await tmPose.load(modelURL, metadataURL);
            
            // Inisialisasi Webcam
            const size = 640;
            const flip = true;
            webcam = new tmPose.Webcam(size, 480, flip);
            
            // WAJIB: Meminta izin browser secara eksplisit
            await webcam.setup(); 
            addLog("Izin kamera diberikan.");
            
            await webcam.play();
            loader.style.display = "none";
            addLog("Kamera Aktif. Mulai memindai pose...");

            window.requestAnimationFrame(loop);

            const canvas = document.getElementById("canvas");
            canvas.width = size; canvas.height = 480;
            ctx = canvas.getContext("2d");

        } catch (e) {
            console.error(e);
            addLog("‚ùå ERROR: " + e.message);
            alert("Gagal mengakses kamera. Pastikan Anda menggunakan HTTPS atau Localhost dan izin kamera diaktifkan.");
            startBtn.disabled = false;
            startBtn.innerText = "Aktifkan Kamera";
            loader.style.display = "none";
        }
    }

    async function loop() {
        webcam.update();
        await predict();
        window.requestAnimationFrame(loop);
    }

    async function predict() {
        if (!webcam.canvas) return;

        const { pose, posenetOutput } = await model.estimatePose(webcam.canvas);
        const prediction = await model.predict(posenetOutput);
        
        drawPose(pose);

        let highest = { name: "", prob: 0 };
        prediction.forEach(p => {
            if(p.probability > highest.prob) highest = { name: p.className, prob: p.probability };
        });

        if(highest.prob > 0.85) {
            document.getElementById("status-label").innerText = highest.name;
            processLogic(highest.name);
        } else {
            if(lightActive) updateLight(false);
        }
    }

    // --- FUNGSI LOGIKA (Pintu & Lampu) SAMA SEPERTI SEBELUMNYA ---
    function processLogic(name) {
        if(name === "Pemilik" && !isOwnerVerified) {
            isOwnerVerified = true;
            document.getElementById("conn-btn").disabled = false;
            document.getElementById("conn-btn").classList.add("active");
            addLog("Pemilik Terverifikasi.");
        }
        if(!isOwnerVerified) return;

        if(name === "Menyalakan Lampu") updateLight(true);
        else updateLight(false);

        if(name === "Membuka Pintu" && !servoActive) updateDoor(true);
    }

    function updateLight(on) {
        if(lightActive === on) return;
        lightActive = on;
        document.getElementById("lampu-status").checked = on;
        sendSerial(on ? "LED_ON" : "LED_OFF");
        addLog(on ? "Lampu ON" : "Lampu OFF");
    }

    function updateDoor(on) {
        servoActive = true;
        document.getElementById("pintu-status").checked = true;
        sendSerial("SERVO_OPEN");
        addLog("Pintu Terbuka (10 Detik)");
        
        setTimeout(() => {
            document.getElementById("pintu-status").checked = false;
            sendSerial("SERVO_CLOSE");
            addLog("Pintu Tertutup");
            servoActive = false;
        }, 10000);
    }

    function drawPose(pose) {
        if (webcam.canvas) {
            ctx.drawImage(webcam.canvas, 0, 0);
            if (pose) tmPose.drawSkeleton(pose.keypoints, 0.5, ctx);
        }
    }

    async function connectSerial() {
        try {
            port = await navigator.serial.requestPort();
            await port.open({ baudRate: 9600 });
            writer = port.writable.getWriter();
            addLog("Arduino Terhubung.");
        } catch (e) { addLog("Gagal Serial."); }
    }

    async function sendSerial(msg) {
        if(writer) {
            const data = new TextEncoder().encode(msg + "\n");
            await writer.write(data);
        }
    }

    function addLog(msg) {
        if(msg === lastLog) return;
        const logBox = document.getElementById("log");
        logBox.innerHTML = `<div>[${new Date().toLocaleTimeString()}] ${msg}</div>` + logBox.innerHTML;
        lastLog = msg;
    }
</script>
</body>
</html>
