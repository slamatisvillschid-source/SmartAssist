<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>AI Security Command Center</title>
    <style>
        :root { --primary: #3b82f6; --danger: #ef4444; --success: #22c55e; --bg: #0f172a; --panel: #1e293b; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: white; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        /* Sidebar Styles */
        .sidebar { width: 380px; background: var(--panel); padding: 25px; border-right: 1px solid #334155; display: flex; flex-direction: column; gap: 20px; }
        .btn-group { display: flex; gap: 10px; margin-bottom: 10px; }
        
        button { flex: 1; padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: 0.3s; }
        .btn-camera { background: var(--primary); color: white; }
        .btn-connect { background: #64748b; color: white; cursor: not-allowed; opacity: 0.5; }
        .btn-connect.active { background: var(--success); cursor: pointer; opacity: 1; }

        .control-card { background: #0f172a; padding: 15px; border-radius: 12px; border: 1px solid #334155; }
        .toggle-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        
        /* Main Area Styles */
        .main-content { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; background: radial-gradient(circle, #1e293b 0%, #0f172a 100%); }
        #webcam-wrapper { position: relative; border-radius: 20px; border: 8px solid #334155; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); overflow: hidden; }
        #status-label { margin-top: 15px; font-size: 1.5rem; font-weight: 700; color: #60a5fa; text-transform: uppercase; letter-spacing: 2px; }
        
        /* Notification Box */
        #log { height: 150px; background: #000; border-radius: 8px; padding: 10px; font-family: 'Courier New', monospace; font-size: 12px; color: #10b981; overflow-y: auto; }
        
        /* Toggle Switch */
        .switch { position: relative; width: 45px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background: #475569; transition: .4s; border-radius: 24px; }
        input:checked + .slider { background: var(--success); }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider:before { transform: translateX(21px); }
    </style>
</head>
<body>

<div class="sidebar">
    <h2 style="margin:0; color: #3b82f6;">CONTROL PANEL</h2>
    
    <div class="btn-group">
        <button class="btn-camera" onclick="init()">Aktifkan Kamera</button>
        <button id="conn-btn" class="btn-connect" onclick="connectSerial()" disabled>Hubungkan Arduino</button>
    </div>

    <div class="control-card">
        <div class="toggle-item">
            <span>ðŸ”“ Auto Buka Pintu (Servo)</span>
            <label class="switch"><input type="checkbox" id="pintu-toggle"><span class="slider"></span></label>
        </div>
        <div class="toggle-item">
            <span>ðŸ’¡ Auto Lampu (LED 10-13)</span>
            <label class="switch"><input type="checkbox" id="lampu-toggle"><span class="slider"></span></label>
        </div>
    </div>

    <div id="log">Sistem Siap. Harap verifikasi identitas Pemilik...</div>
</div>

<div class="main-content">
    <div id="webcam-wrapper">
        <div id="webcam-container"></div>
    </div>
    <div id="status-label">MEMINDAI...</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.3.1/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>

<script>
    const URL = "https://teachablemachine.withgoogle.com/models/ZMNrCQrv8/";
    const TELEGRAM_TOKEN = "8227143038:AAH6f9KMkD7GU3ZVAfl3E0y2zYG51LyUYTo";
    const CHAT_ID = "275146230";
    
    let model, webcam, labelContainer, maxPredictions, port, writer;
    let isOwner = false;
    let lastAlertTime = 0;

    async function init() {
        model = await tmImage.load(URL + "model.json", URL + "metadata.json");
        maxPredictions = model.getTotalClasses();
        webcam = new tmImage.Webcam(500, 400, true);
        await webcam.setup();
        await webcam.play();
        document.getElementById("webcam-container").appendChild(webcam.canvas);
        window.requestAnimationFrame(loop);
    }

    async function loop() {
        webcam.update();
        await predict();
        window.requestAnimationFrame(loop);
    }

    async function predict() {
        const prediction = await model.predict(webcam.canvas);
        let highest = { name: "", prob: 0 };

        prediction.forEach(p => {
            if(p.probability > highest.prob) highest = { name: p.className, prob: p.probability };
        });

        if(highest.prob > 0.90) {
            document.getElementById("status-label").innerText = highest.name;
            handleLogic(highest.name);
        }
    }

    function handleLogic(name) {
        const connBtn = document.getElementById("conn-btn");
        
        if(name === "Pemilik") {
            if(!isOwner) {
                isOwner = true;
                connBtn.disabled = false;
                connBtn.classList.add("active");
                addLog("Akses Pemilik Diterima. USB Diizinkan.");
                speak("Selamat datang pemilik. Perangkat siap dihubungkan.");
            }
        } 
        else if(name === "Orang Lain") {
            triggerAlarm();
        }

        // Action Logic
        if(isOwner && writer) {
            if(name === "Membuka Pintu" && document.getElementById("pintu-toggle").checked) {
                sendSerial("DOOR_OPEN");
            }
            if(name === "Menyalakan Lampu" && document.getElementById("lampu-toggle").checked) {
                sendSerial("LIGHTS_ON");
            }
        }
    }

    function triggerAlarm() {
        let now = Date.now();
        if(now - lastAlertTime > 10000) { // Beri jeda 10 detik antar notifikasi
            lastAlertTime = now;
            addLog("âš ï¸ PERINGATAN: Orang Asing Terdeteksi!");
            speak("Peringatan. Orang tidak dikenal terdeteksi.");
            fetch(`https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage?chat_id=${CHAT_ID}&text=âš ï¸ PERINGATAN: Ada orang asing di depan kamera!`);
        }
    }

    function speak(text) {
        const msg = new SpeechSynthesisUtterance(text);
        msg.lang = 'id-ID';
        window.speechSynthesis.speak(msg);
    }

    async function connectSerial() {
        try {
            port = await navigator.serial.requestPort();
            await port.open({ baudRate: 9600 });
            writer = port.writable.getWriter();
            addLog("Arduino Berhasil Terhubung!");
        } catch (e) { addLog("Koneksi Gagal."); }
    }

    async function sendSerial(cmd) {
        const data = new TextEncoder().encode(cmd + "\n");
        await writer.write(data);
        addLog("Kirim Perintah: " + cmd);
    }

    function addLog(msg) {
        const log = document.getElementById("log");
        log.innerHTML = `> ${msg}<br>` + log.innerHTML;
    }
</script>
</body>
</html>
