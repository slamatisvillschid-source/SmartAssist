<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>SMART ASSIST</title>
    <style>
        :root { --primary: #3b82f6; --danger: #ef4444; --success: #22c55e; --bg: #0f172a; --panel: #1e293b; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: white; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        .sidebar { width: 380px; background: var(--panel); padding: 25px; border-right: 1px solid #334155; display: flex; flex-direction: column; gap: 15px; }
        .control-card { background: #0f172a; padding: 15px; border-radius: 12px; border: 1px solid #334155; }
        
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .stat-box { background: #1e293b; padding: 10px; border-radius: 8px; text-align: center; border: 1px solid #334155; }
        .stat-val { display: block; font-size: 1.1rem; font-weight: bold; color: #60a5fa; }
        .stat-label { font-size: 0.7rem; color: #94a3b8; text-transform: uppercase; }

        button { padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: 0.3s; width: 100%; margin-bottom: 5px; }
        .btn-camera { background: var(--primary); color: white; }
        .btn-report { background: #6366f1; color: white; margin-top: 10px; }
        .btn-report.sent { background: #2563eb !important; }
        .btn-reset { background: var(--danger); color: white; font-size: 0.8rem; padding: 8px; margin-top: 5px; }
        .btn-connect { background: #475569; color: #94a3b8; cursor: not-allowed; }
        .btn-connect.active { background: var(--success); color: white; cursor: pointer; }

        .serial-status { font-size: 0.8rem; padding: 8px; border-radius: 6px; background: #000; color: #94a3b8; margin-top: 5px; text-align: center; border: 1px solid #334155; }
        .serial-active { color: var(--success); border-color: var(--success); }

        .toggle-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; font-size: 0.9rem; }
        .switch { position: relative; width: 40px; height: 22px; pointer-events: none; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: #475569; transition: .4s; border-radius: 22px; }
        input:checked + .slider { background: var(--success); }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider:before { transform: translateX(18px); }

        #canvas-wrapper { position: relative; border-radius: 20px; border: 6px solid #334155; background: #000; overflow: hidden; line-height: 0; }
        #status-label { margin-top: 20px; font-size: 1.8rem; font-weight: 800; color: #64748b; text-align: center; }
        #status-label.verified { color: #60a5fa; }
        
        #log { height: 100px; background: #000; border-radius: 8px; padding: 10px; font-family: monospace; font-size: 11px; color: #10b981; overflow-y: auto; border: 1px solid #334155; }
        .main-content { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    </style>
</head>
<body>

<div class="sidebar">
    <h2 style="margin:0; font-size: 1.2rem; color: #60a5fa;">üõ°Ô∏è AI SMART DASHBOARD</h2>
    
    <button class="btn-camera" id="start-btn" onclick="init()">Aktifkan Kamera</button>
    <button id="conn-btn" class="btn-connect" onclick="connectSerial()" disabled>Hubungkan Arduino</button>
    <div id="serial-info" class="serial-status">Status Serial: Terputus</div>

    <div class="control-card">
        <div class="toggle-item"><span>üîì Pintu (Servo)</span><label class="switch"><input type="checkbox" id="pintu-status"><span class="slider"></span></label></div>
        <div class="toggle-item"><span>üí° Lampu (LED 10-13)</span><label class="switch"><input type="checkbox" id="lampu-status"><span class="slider"></span></label></div>
    </div>

    <div class="control-card">
        <div class="stat-label">SMART ASSIRT</div>
        <div class="stats-grid">
            <div class="stat-box"><span class="stat-val" id="timer-val">0s</span><span class="stat-label">Durasi</span></div>
            <div class="stat-box"><span class="stat-val" id="cost-val">Rp 0</span><span class="stat-label">Biaya</span></div>
        </div>
        <button id="report-btn" class="btn-report" onclick="sendTelegramReport()">üì§ Kirim Laporan</button>
        <button class="btn-reset" onclick="resetEnergy()">üîÑ Reset Perhitungan</button>
    </div>

    <div id="log">Siap...</div>
</div>

<div class="main-content">
    <div id="canvas-wrapper"><canvas id="canvas"></canvas></div>
    <div id="status-label">MENUNGGU VERIFIKASI...</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.3.1/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@teachablemachine/pose@0.8/dist/teachablemachine-pose.min.js"></script>

<script>
    // GANTI URL INI DENGAN URL MODEL ANDA
    //const URL = "https://teachablemachine.withgoogle.com/models/3OXgp5Mri/"; 
    const URL = "https://teachablemachine.withgoogle.com/models/eLtlAPE-d/"; 
    const TG_TOKEN = "8580955378:AAH6WcIiwyYe47Zl90AQzYoEcxrNENi4sAU";
    const TG_CHAT_ID = "507135773";

    let model, webcam, ctx, writer, port;
    let isOwnerVerified = false;
    let lastLogMessage = "";
    
    let lightStartTime = null;
    let totalSecondsActive = 0;
    let isServoRunning = false;
    let isLightOn = false;

    async function init() {
        try {
            model = await tmPose.load(URL + "model.json", URL + "metadata.json");
            webcam = new tmPose.Webcam(600, 450, true);
            await webcam.setup();
            await webcam.play();
            window.requestAnimationFrame(loop);
            const canvas = document.getElementById("canvas");
            canvas.width = 600; canvas.height = 450;
            ctx = canvas.getContext("2d");
            addLog("Kamera Aktif.");
        } catch(e) { addLog("Error Kamera."); }
    }

    async function loop() {
        webcam.update();
        if (isLightOn && lightStartTime) updateEnergyCounter();
        await predict();
        window.requestAnimationFrame(loop);
    }

    async function predict() {
        if (!webcam.canvas) return;
        const { pose, posenetOutput } = await model.estimatePose(webcam.canvas);
        const prediction = await model.predict(posenetOutput);
        drawPose(pose);
        
        let highest = { name: "", prob: 0 };
        prediction.forEach(p => { if(p.probability > highest.prob) highest = { name: p.className, prob: p.probability }; });

        const labelElement = document.getElementById("status-label");

        if(highest.prob > 0.85) {
            if (!isOwnerVerified) {
                if (highest.name === "Pemilik") {
                    labelElement.innerText = "PEMILIK TERDETEKSI";
                    labelElement.classList.add("verified");
                    handleLogic(highest.name);
                } else {
                    labelElement.innerText = "MENUNGGU VERIFIKASI...";
                }
            } else {
                labelElement.innerText = highest.name;
                handleLogic(highest.name);
            }
        }
    }

    function handleLogic(name) {
        if(name === "Pemilik" && !isOwnerVerified) {
            isOwnerVerified = true;
            document.getElementById("conn-btn").disabled = false;
            document.getElementById("conn-btn").classList.add("active");
            addLog("Akses Dibuka.");
        }

        if(!isOwnerVerified) return;

        // PERBAIKAN LOGIKA LED: ON jika "Menyalakan Lampu", OFF hanya jika "Kosong"
        if(name === "Menyalakan Lampu" && !isLightOn) {
            isLightOn = true;
            lightStartTime = Date.now();
            document.getElementById("lampu-status").checked = true;
            sendSerial("LED_ON");
            addLog("Lampu Aktif.");
        } 
        else if(name === "Kosong" && isLightOn) {
            let session = (Date.now() - lightStartTime) / 1000;
            totalSecondsActive += session;
            lightStartTime = null;
            isLightOn = false;
            document.getElementById("lampu-status").checked = false;
            sendSerial("LED_OFF");
            addLog(`Lampu Mati. Durasi Sesi: ${session.toFixed(1)}s`);
        }

        if(name === "Membuka Pintu" && !isServoRunning) {
            openDoor();
        }
    }

    function openDoor() {
        isServoRunning = true;
        document.getElementById("pintu-status").checked = true;
        sendSerial("SERVO_OPEN");
        addLog("Pintu Terbuka.");
        setTimeout(() => {
            document.getElementById("pintu-status").checked = false;
            sendSerial("SERVO_CLOSE");
            addLog("Pintu Tertutup.");
            isServoRunning = false;
        }, 10000);
    }

    function updateEnergyCounter() {
        let currentSession = (Date.now() - lightStartTime) / 1000;
        let total = totalSecondsActive + currentSession;
        document.getElementById("timer-val").innerText = Math.floor(total) + "s";
        let cost = ((40 * (total / 3600)) / 1000) * 1444;
        document.getElementById("cost-val").innerText = "Rp " + cost.toFixed(2);
    }

    function resetEnergy() {
        totalSecondsActive = 0;
        lightStartTime = isLightOn ? Date.now() : null;
        document.getElementById("timer-val").innerText = "0s";
        document.getElementById("cost-val").innerText = "Rp 0";
        addLog("Perhitungan Energi direset.");
    }

    async function sendTelegramReport() {
        const btn = document.getElementById("report-btn");
        const total = document.getElementById("timer-val").innerText;
        const cost = document.getElementById("cost-val").innerText;
        const msg = `üìä *LAPORAN ENERGI*%0A‚è± Total: ${total}%0Aüí∞ Biaya: ${cost}`;
        
        try {
            await fetch(`https://api.telegram.org/bot${TG_TOKEN}/sendMessage?chat_id=${TG_CHAT_ID}&text=${msg}&parse_mode=Markdown`);
            addLog("Laporan Terkirim!");
            btn.classList.add("sent");
            btn.innerText = "‚úÖ TERKIRIM";
            setTimeout(() => {
                btn.classList.remove("sent");
                btn.innerText = "üì§ Kirim Laporan";
            }, 3000);
        } catch (e) { addLog("Gagal kirim Telegram."); }
    }

    async function connectSerial() {
        try {
            port = await navigator.serial.requestPort();
            await port.open({ baudRate: 9600 });
            writer = port.writable.getWriter();
            const info = document.getElementById("serial-info");
            info.innerText = "Status Serial: Terhubung ‚úÖ";
            info.classList.add("serial-active");
            addLog("Arduino Connect!");
        } catch (e) { addLog("Serial Gagal."); }
    }

    async function sendSerial(m) {
        if(writer) {
            const data = new TextEncoder().encode(m + "\n");
            await writer.write(data);
        }
    }

    function drawPose(pose) { ctx.drawImage(webcam.canvas, 0, 0); if (pose) tmPose.drawSkeleton(pose.keypoints, 0.5, ctx); }
    function addLog(m) { if(m !== lastLogMessage) { const b = document.getElementById("log"); b.innerHTML = `> ${m}<br>` + b.innerHTML; lastLogMessage = m; } }
</script>
</body>
</html>
