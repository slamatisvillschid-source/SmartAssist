<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>SMART ASSIST</title>
    <style>
        :root { --primary: #3b82f6; --danger: #ef4444; --success: #22c55e; --bg: #0f172a; --panel: #1e293b; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: white; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        /* Sidebar */
        .sidebar { width: 380px; background: var(--panel); padding: 25px; border-right: 1px solid #334155; display: flex; flex-direction: column; gap: 15px; }
        .control-card { background: #0f172a; padding: 15px; border-radius: 12px; border: 1px solid #334155; }
        
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .stat-box { background: #1e293b; padding: 10px; border-radius: 8px; text-align: center; border: 1px solid #334155; }
        .stat-val { display: block; font-size: 1.1rem; font-weight: bold; color: #60a5fa; }
        .stat-label { font-size: 0.7rem; color: #94a3b8; text-transform: uppercase; }

        button { padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: 0.3s; width: 100%; }
        .btn-camera { background: var(--primary); color: white; margin-bottom: 5px; }
        .btn-report { background: #9333ea; color: white; margin-top: 10px; }
        .btn-connect { background: #475569; color: #94a3b8; cursor: not-allowed; }
        .btn-connect.active { background: var(--success); color: white; cursor: pointer; box-shadow: 0 0 10px var(--success); }

        /* Toggles */
        .toggle-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; font-size: 0.9rem; }
        .switch { position: relative; width: 40px; height: 22px; pointer-events: none; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: #475569; transition: .4s; border-radius: 22px; }
        input:checked + .slider { background: var(--success); }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider:before { transform: translateX(18px); }

        #canvas-wrapper { position: relative; border-radius: 20px; border: 6px solid #334155; background: #000; overflow: hidden; line-height: 0; }
        #status-label { margin-top: 20px; font-size: 1.8rem; font-weight: 800; color: #60a5fa; }
        #log { height: 100px; background: #000; border-radius: 8px; padding: 10px; font-family: monospace; font-size: 11px; color: #10b981; overflow-y: auto; border: 1px solid #334155; }
        
        .main-content { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    </style>
</head>
<body>

<div class="sidebar">
    <h2 style="margin:0; font-size: 1.2rem; color: #60a5fa;">üõ°Ô∏è AI SMART HOME</h2>
    
    <button class="btn-camera" id="start-btn" onclick="init()">Aktifkan Kamera</button>
    <button id="conn-btn" class="btn-connect" onclick="connectSerial()" disabled>Hubungkan Arduino</button>

    <div class="control-card">
        <div class="toggle-item">
            <span>üîì Pintu (Servo)</span>
            <label class="switch"><input type="checkbox" id="pintu-status"><span class="slider"></span></label>
        </div>
        <div class="toggle-item">
            <span>üí° Lampu (LED 10-13)</span>
            <label class="switch"><input type="checkbox" id="lampu-status"><span class="slider"></span></label>
        </div>
    </div>

    <div class="control-card">
        <div class="stat-label">Efisiensi Energi (40W)</div>
        <div class="stats-grid">
            <div class="stat-box"><span class="stat-val" id="timer-val">0s</span><span class="stat-label">Durasi</span></div>
            <div class="stat-box"><span class="stat-val" id="cost-val">Rp 0</span><span class="stat-label">Biaya</span></div>
        </div>
        <button class="btn-report" onclick="sendTelegramReport()">üì§ Kirim Laporan</button>
    </div>

    <div id="log">Siap...</div>
</div>

<div class="main-content">
    <div id="canvas-wrapper"><canvas id="canvas"></canvas></div>
    <div id="status-label">OFFLINE</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.3.1/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@teachablemachine/pose@0.8/dist/teachablemachine-pose.min.js"></script>

<script>
    const URL = "https://teachablemachine.withgoogle.com/models/ZMNrCQrv8/"; 
    const TG_TOKEN = "8227143038:AAH6f9KMkD7GU3ZVAfl3E0y2zYG51LyUYTo";
    const TG_CHAT_ID = "275146230 ";

    let model, webcam, ctx, writer;
    let isOwnerVerified = false;
    let lastLogMessage = "";
    
    // State Tracking
    let lightStartTime = null;
    let totalSecondsActive = 0;
    let isServoRunning = false;
    let isLightOn = false;

    async function init() {
        try {
            model = await tmPose.load(URL + "model.json", URL + "metadata.json");
            webcam = new tmPose.Webcam(600, 450, true);
            await webcam.setup();
            await webcam.play();
            window.requestAnimationFrame(loop);
            const canvas = document.getElementById("canvas");
            canvas.width = 600; canvas.height = 450;
            ctx = canvas.getContext("2d");
            addLog("MODE Aktif. Harap verifikasi Pemilik.");
        } catch(e) { addLog("Error Kamera."); }
    }

    async function loop() {
        webcam.update();
        if (lightStartTime) updateEnergyCounter();
        await predict();
        window.requestAnimationFrame(loop);
    }

    async function predict() {
        if (!webcam.canvas) return;
        const { pose, posenetOutput } = await model.estimatePose(webcam.canvas);
        const prediction = await model.predict(posenetOutput);
        drawPose(pose);
        
        let highest = { name: "", prob: 0 };
        prediction.forEach(p => { if(p.probability > highest.prob) highest = { name: p.className, prob: p.probability }; });

        if(highest.prob > 0.85) {
            document.getElementById("status-label").innerText = highest.name;
            handleLogic(highest.name);
        }
    }

    function handleLogic(name) {
        // 1. Verifikasi Pemilik
        if(name === "Pemilik" && !isOwnerVerified) {
            isOwnerVerified = true;
            document.getElementById("conn-btn").disabled = false;
            document.getElementById("conn-btn").classList.add("active");
            addLog("Pemilik Dikenali. Akses Dibuka.");
        }

        if(!isOwnerVerified) return;

        // 2. Logika Lampu (Sticky ON sampai Kosong)
        if(name === "Menyalakan Lampu" && !isLightOn) {
            isLightOn = true;
            lightStartTime = Date.now();
            document.getElementById("lampu-status").checked = true;
            sendSerial("LED_ON");
            addLog("Lampu Dinyalakan.");
        } 
        else if(name === "Kosong" && isLightOn) {
            let session = (Date.now() - lightStartTime) / 1000;
            totalSecondsActive += session;
            lightStartTime = null;
            isLightOn = false;
            document.getElementById("lampu-status").checked = false;
            sendSerial("LED_OFF");
            addLog(`Lampu Dimatikan. Sesi: ${session.toFixed(1)}s`);
        }

        // 3. Logika Pintu (Servo 10 Detik)
        if(name === "Membuka Pintu" && !isServoRunning) {
            openDoor();
        }
    }

    function openDoor() {
        isServoRunning = true;
        document.getElementById("pintu-status").checked = true;
        sendSerial("SERVO_OPEN");
        addLog("Membuka Pintu (Auto-close 10s)");
        
        setTimeout(() => {
            document.getElementById("pintu-status").checked = false;
            sendSerial("SERVO_CLOSE");
            addLog("Pintu Ditutup.");
            isServoRunning = false;
        }, 10000);
    }

    function updateEnergyCounter() {
        let currentSession = (Date.now() - lightStartTime) / 1000;
        let total = totalSecondsActive + currentSession;
        document.getElementById("timer-val").innerText = Math.floor(total) + "s";
        let kwh = (40 * (total / 3600)) / 1000;
        let cost = kwh * 1444;
        document.getElementById("cost-val").innerText = "Rp " + cost.toFixed(2);
    }

    async function sendTelegramReport() {
        const total = document.getElementById("timer-val").innerText;
        const cost = document.getElementById("cost-val").innerText;
        const msg = `üìä *LAPORAN ENERGI*%0A‚è± Total Nyala: ${total}%0Aüí∞ Est. Biaya: ${cost}%0A‚úÖ Status: Aman`;
        try {
            await fetch(`https://api.telegram.org/bot${TG_TOKEN}/sendMessage?chat_id=${TG_CHAT_ID}&text=${msg}&parse_mode=Markdown`);
            addLog("Laporan Terkirim!");
        } catch (e) { addLog("Gagal kirim laporan."); }
    }

    function drawPose(pose) { ctx.drawImage(webcam.canvas, 0, 0); if (pose) tmPose.drawSkeleton(pose.keypoints, 0.5, ctx); }
    async function connectSerial() { try { const port = await navigator.serial.requestPort(); await port.open({ baudRate: 9600 }); writer = port.writable.getWriter(); addLog("USB Connect!"); } catch(e) {} }
    async function sendSerial(m) { if(writer) writer.write(new TextEncoder().encode(m + "\n")); }
    function addLog(m) { if(m !== lastLogMessage) { const b = document.getElementById("log"); b.innerHTML = `> ${m}<br>` + b.innerHTML; lastLogMessage = m; } }
</script>
</body>
</html>
